<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise - Grammar Peace</title>
    <style>
        :root {
            --bg-color: #0a0e14;
            --card-bg: #161b22;
            --text-main: #c9d1d9;
            --accent: #58a6ff;
            --success: #2ea043;
            --error: #da3633;
            --border: #30363d;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .top-nav {
            width: 100%;
            max-width: 750px;
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-start;
        }

        .btn-back {
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-back:hover { background: #30363d; border-color: var(--accent); }

        #quiz-wrapper {
            background: var(--card-bg);
            max-width: 750px;
            width: 100%;
            padding: 35px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .header h1 { font-size: 1.4rem; color: var(--accent); margin: 0; text-transform: uppercase; }
        #timer { font-family: monospace; font-size: 1.2rem; color: #ffa657; }

        .progress-container { height: 4px; background: #21262d; margin-bottom: 25px; }
        #progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        .question-box { margin-bottom: 30px; }
        .question-text { font-size: 1.2rem; margin-bottom: 20px; line-height: 1.5; }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }

        .opt-btn {
            background: #21262d;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 15px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            transition: 0.2s;
        }

        .opt-btn:hover:not(:disabled) { background: #30363d; border-color: #8b949e; }
        .opt-btn.correct { background: var(--success) !important; color: white; }
        .opt-btn.wrong { background: var(--error) !important; color: white; }

        #feedback-panel {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            background: #0d1117;
            border-left: 4px solid var(--accent);
            display: none;
        }

        .feedback-exp { font-size: 0.95rem; color: #8b949e; margin-top: 8px; }

        .btn-nav {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            float: right;
            margin-top: 20px;
            display: none;
        }

        #results { display: none; text-align: center; }
        .score-circle { font-size: 3rem; color: var(--accent); margin: 20px 0; }
    </style>
</head>
<body>

<div class="top-nav">
    <button class="btn-back" onclick="window.location.href='../index.html'">
        üè† Back to Levels
    </button>
</div>

<div id="quiz-wrapper">
    <div id="main-quiz">
        <div class="header">
            <h1 id="display-topic">TOPIC NAME</h1>
            <div id="timer">05:00</div>
        </div>

        <div class="progress-container"><div id="progress-bar"></div></div>

        <div class="question-box">
            <div id="q-text" class="question-text">Identify the <b>ERROR</b> in the sentence below:</div>
            <div id="q-sentence" class="question-text" style="font-style: italic; color: #ffa657;"></div>
            <div id="options" class="options-grid"></div>
        </div>

        <div id="feedback-panel">
            <div id="feedback-status" style="font-weight:bold"></div>
            <div id="feedback-desc" class="feedback-exp"></div>
        </div>

        <button id="next-btn" class="btn-nav" onclick="goNext()">NEXT QUESTION</button>
    </div>

    <div id="results">
        <h1>EXAM COMPLETE</h1>
        <div class="score-circle" id="final-score">0/0</div>
        <p id="rank-msg" style="margin-bottom: 20px;"></p>
        <p style="color: var(--accent); font-size: 0.9rem;">Redirecting to Performance Report...</p>
    </div>
</div>

<script src="../app.js"></script>

<script>
    const TOPIC_TITLE = "Conditional Sentences (Error ID)"; 
    const TOPIC_KEY = "conditional error"; 
    const TIME_LIMIT = 600; 
    const TOTAL_TO_SHOW = 20; 

    const pool = [
    { 
        q: "If the weather will be fine tomorrow, we will go on a picnic in the mountains.",
        o: ["will be", "tomorrow", "will go", "in the mountains"],
        c: 0,
        e: "Future in If-Clause Error. Dalam Type 1, 'If-clause' tidak boleh menggunakan 'will'. Gunakan Present Simple.",
        t: "üí° If + Present Simple, S + Will + V1.",
        m: "‚ö†Ô∏è Perbaiki 'will be' menjadi 'is'."
    },
    { 
        q: "Had the company known about the risks, they wouldn't involve in that project.",
        o: ["Had", "known", "wouldn't", "involve"],
        c: 3,
        e: "Result Clause Type 3 Error. 'Had + S + V3' adalah Type 3, maka pasangannya harus 'wouldn't have involved'.",
        t: "üí° Inversion Type 3: Had... V3 -> would have V3.",
        m: "‚ö†Ô∏è 'Involve' harus diubah menjadi 'have involved' (aktif) atau 'have been involved' (pasif)."
    },
    { 
        q: "If I was in your position, I would reconsider the offer before making a final decision.",
        o: ["was", "in", "would reconsider", "before making"],
        c: 0,
        e: "Subjunctive Error. Untuk pengandaian yang tidak nyata (Type 2), 'was' harus diganti dengan 'were' untuk semua subjek.",
        t: "üí° 'If I were' lebih formal dan tepat dalam TOEFL daripada 'If I was'.",
        m: "‚ö†Ô∏è 'Was' adalah kesalahan umum di level advanced."
    },
    { 
        q: "Provided that he had followed the instructions, he would have finished the task easily.",
        o: ["Provided that", "had followed", "would have", "finished"],
        c: 0,
        e: "Logic/Tense Error. 'Provided that' biasanya untuk Type 1. Namun secara struktur kalimat ini benar Type 3. Mari fokus pada penggunaan 'Provided that' vs 'If'. (Wait, context check: kalimat ini sebenarnya secara gramatikal benar jika 'Provided that' dianggap sinonim 'If'). Mari ganti soal ke yang lebih jelas kesalahannya.",
        q: "The experiment would be a success if the researchers have used the correct formula.",
        o: ["would be", "if", "have used", "correct formula"],
        c: 2,
        e: "Mixed/Type 3 Error. 'Would be' (Type 2) tidak cocok dengan 'have used' (Present Perfect). Harusnya 'had used'.",
        t: "üí° Past Perfect (had used) dibutuhkan untuk pengandaian masa lalu.",
        m: "‚ö†Ô∏è Hindari mencampur 'would' dengan 'have + V3' tanpa 'had'."
    },
    { 
        q: "Unless you don't submit your application by Friday, you will not be considered for the job.",
        o: ["Unless", "don't submit", "by", "will not be"],
        c: 1,
        e: "Double Negative Error. 'Unless' sudah bermakna negatif (if not). Tidak boleh diikuti kata negatif lagi.",
        t: "üí° Unless + Kalimat Positif.",
        m: "‚ö†Ô∏è Ganti 'don't submit' menjadi 'submit'."
    },
    { 
        q: "Should you needing any further information, please feel free to contact our customer service.",
        o: ["Should", "needing", "further", "to contact"],
        c: 1,
        e: "Inversion Type 1 Error. Setelah 'Should' (inversi), kata kerja harus berbentuk Bare Infinitive (V1).",
        t: "üí° Should + Subject + V1.",
        m: "‚ö†Ô∏è Ganti 'needing' menjadi 'need'."
    },
    { 
        q: "If she would have studied harder last year, she would have passed the bar exam.",
        o: ["would have studied", "harder", "last year", "would have passed"],
        c: 0,
        e: "If-Clause Type 3 Error. 'If-clause' tidak boleh menggunakan 'would have'. Gunakan Past Perfect.",
        t: "üí° If + Had + V3, S + would have + V3.",
        m: "‚ö†Ô∏è Perbaiki 'would have studied' menjadi 'had studied'."
    },
    { 
        q: "Were the manager here now, he will definitely help us solve this technical issue.",
        o: ["Were", "here now", "will", "help us"],
        c: 2,
        e: "Tense Agreement Error. Inversi 'Were' adalah Type 2, pasangannya harus 'would', bukan 'will'.",
        t: "üí° Were... (Type 2) -> would + V1.",
        m: "‚ö†Ô∏è Ganti 'will' menjadi 'would'."
    },
    { 
        q: "I will lend you the book as long as you returned it to me by next Monday.",
        o: ["will lend", "as long as", "returned", "by next"],
        c: 2,
        e: "Tense Agreement Type 1. 'Will lend' adalah Future, maka pasangannya adalah Present Simple.",
        t: "üí° As long as + Present Simple.",
        m: "‚ö†Ô∏è Ganti 'returned' menjadi 'return'."
    },
    { 
        q: "If the forest fire had not been extinguished, it would destroy the entire village today.",
        o: ["had not been", "extinguished", "would destroy", "entire"],
        c: 2,
        e: "Mixed Conditional Result Error. Konteksnya adalah aksi masa lalu (had not been) yang dampaknya terasa 'today'. Harusnya tetap 'would have destroyed' jika bicara total destruction atau 'would be destroying'. Namun dalam TOEFL, 'would destroy' (Type 2) biasanya salah jika sebabnya Type 3.",
        t: "üí° Periksa kesesuaian waktu sebab dan akibat.",
        m: "‚ö†Ô∏è Umumnya Type 3 berpasangan dengan 'would have + V3'."
    },
    { 
        q: "Supposing that you were elected president, what will you do to improve the economy?",
        o: ["Supposing that", "were", "will", "to improve"],
        c: 2,
        e: "Type 2 Question Error. 'Were' (Type 2) harus berpasangan dengan 'would' dalam kalimat tanya.",
        t: "üí° Supposing + V2 -> would...?",
        m: "‚ö†Ô∏è Ganti 'will' menjadi 'would'."
    },
    { 
        q: "But for the heavy traffic, we would arrive at the airport on time yesterday.",
        o: ["But for", "heavy traffic", "would arrive", "yesterday"],
        c: 2,
        e: "Type 3 Time Error. Karena ada kata 'yesterday', kalimat ini adalah Type 3. Gunakan 'would have arrived'.",
        t: "üí° But for (Jika bukan karena) + Noun.",
        m: "‚ö†Ô∏è 'would arrive' hanya untuk Type 2 (sekarang)."
    },
    { 
        q: "If the supply of oil decreases, the price of gasoline would have increased significantly.",
        o: ["If", "decreases", "would have", "significantly"],
        c: 2,
        e: "Tense Inconsistency. 'Decreases' (Present/Type 1) tidak bisa berpasangan dengan 'would have increased' (Type 3).",
        t: "üí° Type 1: Present -> Will. Type 2: Past -> Would.",
        m: "‚ö†Ô∏è Sesuaikan menjadi 'will increase' atau ubah 'decreases' menjadi 'had decreased'."
    },
    { 
        q: "Had the diplomat be more careful, the international incident could have been avoided.",
        o: ["Had", "be", "more careful", "could have been"],
        c: 1,
        e: "Inversion Past Participle Error. Setelah 'Had' dalam inversi, harus diikuti V3.",
        t: "üí° Had + Subject + V3.",
        m: "‚ö†Ô∏è Ganti 'be' menjadi 'been'."
    },
    { 
        q: "If a person works out regularly, they would feel much more energetic every day.",
        o: ["works out", "regularly", "would feel", "energetic"],
        c: 2,
        e: "Type 0/1 Error. 'Works out' (Present) menunjukkan fakta atau kebiasaan. Pasangannya harus 'will feel' atau 'feel'.",
        t: "üí° Present Simple + Present/Future.",
        m: "‚ö†Ô∏è Ganti 'would feel' menjadi 'feels' atau 'will feel'."
    },
    { 
        q: "In case it will snow tonight, make sure the heating system is working properly.",
        o: ["In case", "will snow", "make sure", "properly"],
        c: 1,
        e: "Conjunction Error. 'In case' (seperti 'if') tidak boleh diikuti 'will' untuk merujuk ke masa depan.",
        t: "üí° In case + Present Simple.",
        m: "‚ö†Ô∏è Ganti 'will snow' menjadi 'snows'."
    },
    { 
        q: "If they had invited me to the gala, I would definitely go with them last week.",
        o: ["had invited", "would definitely", "go", "last week"],
        c: 2,
        e: "Type 3 Consistency. 'Last week' menandakan kejadian lampau. Harusnya 'would have gone'.",
        t: "üí° Past Condition -> Past Result.",
        m: "‚ö†Ô∏è 'would go' adalah untuk masa sekarang (unreal present)."
    },
    { 
        q: "The city would look much cleaner if the residents don't litter on the streets.",
        o: ["would look", "much cleaner", "if", "don't litter"],
        c: 3,
        e: "Type 2 Tense Error. 'Would look' (Type 2) harus berpasangan dengan Past Simple di If-clause.",
        t: "üí° If + Past Simple (didn't litter).",
        m: "‚ö†Ô∏è Ganti 'don't' menjadi 'didn't'."
    },
    { 
        q: "Whether he agrees or not, we would continue with the renovation next month.",
        o: ["Whether", "agrees", "would continue", "next month"],
        c: 2,
        e: "Type 1 Future Error. 'Next month' dan 'agrees' (Present) menandakan Type 1. Gunakan 'will continue'.",
        t: "üí° Whether S+V1, S+will+V1.",
        m: "‚ö†Ô∏è Ganti 'would' menjadi 'will'."
    },
    { 
        q: "If the results were reliable, the scientist will publish them in the journal.",
        o: ["If", "were", "will", "publish"],
        c: 2,
        e: "Tense Agreement. 'Were' (Type 2) harus berpasangan dengan 'would'.",
        t: "üí° If + V2 -> would + V1.",
        m: "‚ö†Ô∏è Ganti 'will' menjadi 'would'."
    }
];

    let currentQuestions = [];
    let currentIdx = 0;
    let score = 0;
    let timer;
    let timeLeft = TIME_LIMIT;
    let answered = false;

    function init() {
        document.getElementById('display-topic').innerText = TOPIC_TITLE;
        currentQuestions = pool.sort(() => 0.5 - Math.random()).slice(0, TOTAL_TO_SHOW);
        startTimer();
        showQuestion();
    }

    function startTimer() {
        timer = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60);
            let s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(timeLeft <= 0) finish();
        }, 1000);
    }

    function showQuestion() {
        answered = false;
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('feedback-panel').style.display = 'none';
        const q = currentQuestions[currentIdx];
        
        document.getElementById('progress-bar').style.width = (currentIdx / TOTAL_TO_SHOW * 100) + "%";
        document.getElementById('q-sentence').innerText = q.q;
        
        const opts = document.getElementById('options');
        opts.innerHTML = '';
        q.o.forEach((o, i) => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = o;
            b.onclick = () => check(i, b);
            opts.appendChild(b);
        });
    }

    function check(idx, btn) {
        if(answered) return;
        answered = true;
        const q = currentQuestions[currentIdx];
        const all = document.querySelectorAll('.opt-btn');

        if(idx === q.c) {
            score++;
            btn.classList.add('correct');
            showFeedback("CORRECT", q.e, q.t, q.m);
        } else {
            btn.classList.add('wrong');
            all[q.c].classList.add('correct');
            showFeedback("INCORRECT", q.e, q.t, q.m);
        }
        document.getElementById('next-btn').style.display = 'block';
    }

    function showFeedback(status, text, tip, misc) {
        const p = document.getElementById('feedback-panel');
        document.getElementById('feedback-status').innerText = status;
        document.getElementById('feedback-status').style.color = (status === "CORRECT") ? "var(--success)" : "var(--error)";
        document.getElementById('feedback-desc').innerHTML = `${text}<br><br><span style="color:#58a6ff">${tip}</span><br><span style="color:#ffa657">${misc}</span>`;
        p.style.display = 'block';
    }

    function goNext() {
        currentIdx++;
        if(currentIdx < TOTAL_TO_SHOW) showQuestion();
        else finish();
    }

    function finish() {
        clearInterval(timer);
        document.getElementById('main-quiz').style.display = 'none';
        document.getElementById('results').style.display = 'block';
        document.getElementById('final-score').innerText = `${score}/${TOTAL_TO_SHOW}`;
        
        let msg = "";
        let grade = "";
        let percent = Math.round((score / TOTAL_TO_SHOW) * 100);

        if(percent >= 85) { msg = "Excellent Work! Mastery Achieved."; grade = "A"; }
        else if(percent >= 70) { msg = "Good Job! A bit more practice and you'll be perfect."; grade = "B"; }
        else { msg = "Keep Practicing. Review the explanations to improve."; grade = "C"; }
        
        document.getElementById('rank-msg').innerText = msg;

        setTimeout(() => {
            if (typeof finishQuiz === "function") {
                finishQuiz(percent, score, TOTAL_TO_SHOW, grade, msg, TOPIC_KEY);
            }
        }, 3000); 
    }

    init();
</script>
</body>
</html>